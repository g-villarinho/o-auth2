# Makefile para gerenciar containers Docker do MongoDB

.PHONY: help up down start stop restart logs status clean clean-all

# Comando padrÃ£o - mostra ajuda
help:
	@echo "Comandos disponÃ­veis:"
	@echo "  make up      - Subir containers em background"
	@echo "  make start   - Subir containers em background"
	@echo "  make down    - Parar e remover containers"
	@echo "  make stop    - Parar containers"
	@echo "  make restart - Reiniciar containers"
	@echo "  make logs    - Ver logs dos containers"
	@echo "  make status  - Ver status dos containers"
	@echo "  make clean   - Parar containers e remover volumes"
	@echo "  make clean-all - Parar containers, remover volumes e imagens"

# Subir containers em background
up:
	@echo "ğŸš€ Subindo containers MongoDB..."
	docker compose up -d
	@echo "âœ… Containers iniciados!"
	@echo "ğŸ“Š MongoDB disponÃ­vel em: localhost:27017"
	@echo "ğŸŒ MongoDB Express disponÃ­vel em: http://localhost:8081"

# Alias para up
start: up

# Parar e remover containers
down:
	@echo "ğŸ›‘ Parando containers..."
	docker-compose down
	@echo "âœ… Containers parados e removidos!"

# Parar containers (sem remover)
stop:
	@echo "â¸ï¸  Parando containers..."
	docker-compose stop
	@echo "âœ… Containers parados!"

# Reiniciar containers
restart:
	@echo "ğŸ”„ Reiniciando containers..."
	docker-compose restart
	@echo "âœ… Containers reiniciados!"

# Ver logs dos containers
logs:
	@echo "ğŸ“‹ Logs dos containers:"
	docker-compose logs -f

# Ver logs apenas do MongoDB
logs-mongo:
	@echo "ğŸ“‹ Logs do MongoDB:"
	docker-compose logs -f mongodb

# Ver logs apenas do MongoDB Express
logs-express:
	@echo "ğŸ“‹ Logs do MongoDB Express:"
	docker-compose logs -f mongo-express

# Ver status dos containers
status:
	@echo "ğŸ“Š Status dos containers:"
	docker-compose ps

# Limpar containers e volumes (cuidado - apaga dados)
clean:
	@echo "ğŸ§¹ Limpando containers e volumes..."
	docker-compose down -v
	@echo "âœ… Containers e volumes removidos!"

# Limpeza completa (containers, volumes e imagens)
clean-all:
	@echo "ğŸ§¹ Limpeza completa..."
	docker-compose down -v --rmi all
	@echo "âœ… Tudo removido!"

# Verificar se containers estÃ£o rodando
check:
	@echo "ğŸ” Verificando status dos containers..."
	@if docker-compose ps | grep -q "Up"; then \
		echo "âœ… Containers estÃ£o rodando!"; \
		echo "ğŸ“Š MongoDB: localhost:27017"; \
		echo "ğŸŒ MongoDB Express: http://localhost:8081"; \
	else \
		echo "âŒ Containers nÃ£o estÃ£o rodando. Execute 'make up' para iniciar."; \
	fi

# Conectar ao MongoDB via shell
shell:
	@echo "ğŸš Conectando ao MongoDB shell..."
	docker-compose exec mongodb mongosh -u admin -p password123

# Backup do banco
backup:
	@echo "ğŸ’¾ Criando backup do MongoDB..."
	mkdir -p backups
	docker-compose exec mongodb mongodump --username admin --password password123 --authenticationDatabase admin --db aetheris --out /data/backup
	docker cp mongodb:/data/backup ./backups/$(shell date +%Y%m%d_%H%M%S)
	@echo "âœ… Backup criado em ./backups/"

# Restaurar backup
restore:
	@echo "ğŸ“¥ Restaurando backup do MongoDB..."
	@if [ -z "$(BACKUP_DIR)" ]; then \
		echo "âŒ Especifique o diretÃ³rio do backup: make restore BACKUP_DIR=./backups/20231201_120000"; \
		exit 1; \
	fi
	docker cp $(BACKUP_DIR) mongodb:/data/restore
	docker-compose exec mongodb mongorestore --username admin --password password123 --authenticationDatabase admin /data/restore
	@echo "âœ… Backup restaurado!" 


.PHONY: generate-key
generate-key:  ## Gera as chaves do projeto
	@echo ${YELLOW}Generating keys${WHITE}
	@echo "ğŸ”‘ Gerando chaves principais..."
	@openssl ecparam -name prime256v1 -genkey -noout -out ecdsa_private.pem
	@openssl ec -in ecdsa_private.pem -pubout -out ecdsa_public.pem
	@echo "ğŸ”‘ Gerando chaves para OTP..."
	@openssl ecparam -name prime256v1 -genkey -noout -out ecdsa_otp_private.pem
	@openssl ec -in ecdsa_otp_private.pem -pubout -out ecdsa_otp_public.pem
	@echo "ğŸ”‘ Gerando chaves para Access Token..."
	@openssl ecparam -name prime256v1 -genkey -noout -out ecdsa_access_token_private.pem
	@openssl ec -in ecdsa_access_token_private.pem -pubout -out ecdsa_access_token_public.pem
	@echo "ğŸ”‘ Gerando chaves para Refresh Token..."
	@openssl ecparam -name prime256v1 -genkey -noout -out ecdsa_refresh_token_private.pem
	@openssl ec -in ecdsa_refresh_token_private.pem -pubout -out ecdsa_refresh_token_public.pem
	@echo "âœ… Todas as chaves foram geradas com sucesso!"